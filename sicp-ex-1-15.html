<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<title>SICP Exercise</title>
<style type="text/css">
  div#bs-console{
    border:1px solid black;
    padding:1em;
    margin-top:1em;
  }
  div#bs-opecode{
    border:1px solid black;
    padding:1em;
    margin-top:1em;
  }
  span.dump_opecode{ color:orange; }
  span.dump_constant{ color:red; }
  div.bs-snippet{
    white-space:pre;
    cursor:pointer;
  }
  textarea{
    font-family:monospace, serif;
  }
  blockquote{
    margin:1rem 0;
    padding:.5rem 1rem .5rem .75rem;
    border-inline-start:.25rem solid #e9ecef;
    border-radius:.25rem
  }
</style>
<script>
MathJax = {
  chtml: {
    matchFontHeight: false
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>
</head>
<body>

<h1>SICP Exercise 1.15</h1>

<blockquote>
The sine of an angle (specified in radians)
can be computed by making use of the approximation \(\sin x \approx x\) if \(x\) is sufficiently small, and the trigonometric identity
\[
\sin x=3\sin\frac{x}{3}-4\sin^3\frac{x}{3}
\]
to reduce the size of the argument of \(\sin\).
(For purposes of this exercise an angle is considered “sufficiently small”if its magnitude is not greater than 0.1 radians.) These ideas are incorporated in the following procedures:
<pre><code>
(define (cube x) (* x x x))
(define (p x) (- (* 3 x) (* 4 (cube x))))
(define (sine angle)
  (if (not (> (abs angle) 0.1))
      angle
      (p (sine (/ angle 3.0)))))
</code></pre>
a. How many times is the procedure p applied when <tt>(sine 12.15)</tt> is evaluated?<br>
b. What is the order of growth in space and number of steps (as a function of a) used by the process generated by the sine procedure when <tt>(sine a)</tt> is evaluated?
</blockquote>

<table><tr><td valign="top">
<textarea id="bs-input" rows="34" cols="80">
(define (displayn n str)
  (define (iter count)
     (if (< count 1)
         ()
         (begin (display str) (iter (- count 1)))))
  (iter n))

(define (cube x) (* x x x))
(define (p x) (- (* 3 x) (* 4 (cube x))))
(define (sine angle n)
  (displayn n "(p ")
  (display "(sine ") (display angle) (display ")")
  (displayn n ")")
  (print "")
  (if (not (> (abs angle) 0.1))
      angle
      (p (sine (/ angle 3.0) (+ n 1)))))

(sine 12.15 0)
</textarea><br>
<div style="float:right;">
<span id="time"></span>
<input type="button" value="eval" onclick="bs_eval()">
</div><br style="clear:both"/>
<div id="bs-console"></div>
<div id="bs-opecode"></div>
</td></tr></table>

a. p は 以下のように 5 回評価される
<pre>
0 step: (sine 12.5)
1 step: (p (sine 4.166666666666667))
2 step: (p (p (sine 1.388888888888889)))
3 step: (p (p (p (sine 0.462962962962963))))
4 step: (p (p (p (p (sine 0.154320987654321)))))
5 step: (p (p (p (p (p (sine 0.051440329218107005))))))
</pre>

b. 空間は末尾再起のため評価対象の angle だけを記憶すればよいので\(\Theta(1)\) <br>
aを3でステップ数(n)回割った値が0.1より小さくなったときに終了する。これを式にすると\(\frac{a}{3^n} < 0.1\)。
\[
\begin{align}
\frac{a}{3^n} &< 0.1 \\
\frac{a}{0.1} &< 3^n \\
log\left(\frac{a}{0.1}\right) &< log(3^n) \\
log(a)-log(0.1) &< n log(3) \\
\frac{log(a)-log(0.1)}{log(3)} &< n \\
\frac{log(a)}{log(3)}-\frac{log(0.1)}{log(3)} &< n \\
log_3(a)-log_3(0.1) &< n \\
\end{align}
\]
よって、ステップの増加オーダーは\(\Theta(log_3(a))\)である。
<script src="./jquery.js"></script>
<script type="module" src="./biwascheme-0.7.5.js"></script>
<script type="module">
let on_error = function(e) {
  BiwaScheme.Port.current_error.put_string(e.message);
  throw(e);
};
window.bs_eval = function() {
  $("#bs-console").empty();
  $("#bs-opecode").empty();
  let src = $("#bs-input").val();
  let before = new Date();
  let comment = false
  let code = ''
  src.split(/\r?\n/).forEach(function(str, key, arr) {
    code += str + '\n'
    if (!comment && str == '#|') comment = true
    else if (comment && str == '|#') comment = false
    else if (!comment && code.replace(/\r?\n/g, '').length != 0 &&
      (str.replace(/\r?\n/g, '').length == 0 || key == arr.length - 1)) {
      let biwascheme = new BiwaScheme.Interpreter(on_error);
      let vmcode = biwascheme.compile(code);
      let dump = (new BiwaScheme.Dumper()).dump_opc(vmcode.il);
      $("#bs-opecode").append(dump + '<br>');
      biwascheme.evaluate(code, function(result) {
        $("#bs-console").append(result + '<br>');
      })
      code = ''
    }
  });
  let after = new Date();
  $("#time").html("Time: " + (after - before) / 1000 + "sec");
  return false;
}
</script>
</body>
</html>
